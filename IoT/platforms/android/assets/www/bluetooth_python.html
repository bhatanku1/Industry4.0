<!DOCTYPE html>
<html>
<meta charset="UTF-8">

<head>

	<script src="js/jquery-1.11.3.min.js"></script>
	<script src="js/jquery.blockUI.min.js"></script>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript"
            src="https://www.google.com/jsapi?autoload={
            'modules':[{
              'name':'visualization',
              'version':'1',
              'packages':['corechart']
            }]
          }"></script>
	<script type="text/javascript" src="cordova_plugins.js"></script>
	<link href="lib/ionic/css/ionic.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/bluetooth.css">
    <script type="text/javascript" src="js/mqttws31.js"></script>

</head>

<style>
    div.graph {
    position: absolute;
	top: 50%;
    left: 10px;
    <!--border: 3px solid #bbbbbb;-->
    }
</style>
<body>

<div class="bar bar-header bar-dark">

	<a href = "ui.html"><button class="button button-clear button-light ion-android-arrow-back"></button></a>
	<h1 class="title">Bluetooth Devices</h1>
	<a class="button button-right button-clear button-light ion-gear-a" href = "settings.html"></a>
	<!--<button id="btn_settings" class="button button-right button-clear button-light ion-gear-a" ><a href = "settings.html"></a></button> -->

</div>

<br>
<br>
<br>

<div class="list">

	<div class="item item-input-inset">
		<label class="item-input-wrapper">
			<i class="icon ion-search placeholder-icon"></i>
			<input id="text_macid" type="text" placeholder="Enter the bluetooth id" name="pub"/>
		</label>
		<button id = "btn_pub" class="button button-clear button-dark button-small ion-arrow-swap" onclick="#">
			Pair
		</button>
	</div>

</div>

<div id="sub">
	<a>
		<button id = "btn_sub" class="button  button-clear button-dark ion-compose" onclick="subscribe()">
			Subscribe
		</button>
	</a>
</div>

<div id="start">
	<a>
		<button id = "btn_start" class="button button-clear  button-dark ion-power" onclick="startMillingMachine()">
			Start
		</button>
	</a>
</div>

<div id="stop">
	<a>
		<button id = "btn_stop" class="button button-clear button-dark ion-android-hand" onclick="milling_stop()">
			Stop
		</button>
	</a>
</div>

<br>

<div id="bt_list" class="card">
	<div class="item item-divider bar bar-header bar-dark">
		Real Time Data
	</div>
	<div class="item item-text-wrap">
		<p>Force Value: </p>
		<p id="bluetoothData"></p>
	</div>
</div>

<!--
<h3 id="fHeader"></h3><br>
<p id = "bluetoothData"></p>
<p id="sub"></p>
 -->

<div class = "graph", id="curve_chart" style="width: 340px; height: 200px">
</div>

<div class="tabs-striped tabs-background-dark tabs-color-light">
	<div class="tabs">
		<a class="tab-item" href="wifi.html">
			<i class="icon ion-wifi"></i>
			Wifi
		</a>
		<a class="tab-item active" href="bluetooth_python.html">
			<i class="icon ion-bluetooth"></i>
			Bluetooth
		</a>
		<a class="tab-item" href="opcua.html">
			<i class="icon ion-shuffle"></i>
			OPCUA
		</a>
	</div>
</div>

<script>

function loadScript()
    {
        // Adding the script tag to the head as suggested before
        alert('inside loadscript');
        var head = document.getElementsByTagName('head')[0];
        var script = document.createElement(secondf.js);
        script.type = 'text/javascript';
        script.src = 'secondf.js';
        script.async = false;
        // Then bind the event to the callback function.
        // There are several events for cross browser compatibility.
        script.onreadystatechange = 'demo2';
        script.onload = 'demo2';

        // Fire the loading
        head.appendChild('secondf.js');
    }

	  var currentForce = 0;
	  var i = 0;
	  var j = 0;
	  var k = 0;
	  var l = 0;
	  var m = 0;
	  var n = 0;
	  var o = 0;
	  var chart = null;
	  google.setOnLoadCallback(drawChart);
	  function drawChart() {
          data = google.visualization.arrayToDataTable([
          ['time', 'Force'],
          ['-21 sec',  0],
          ['-18 sec',  0],
          ['-15 sec',  0],
          ['-12 sec',  0],
          ['-9 sec',  0],
          ['-6 sec',  0],
          ['-3 sec',  0],
          ['current',  0]
        ]);
         options = {
         title: 'Data from the Intelligent device',
         curveType: 'function',
         legend: { position: 'bottom' }
         };
         chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
         chart.draw(data, options);
      }

      function graphUpdate() {

         data = google.visualization.arrayToDataTable([
          ['Year', 'Sales'],
          ['-21 sec',  i],
		  ['-18 sec',  j],
          ['-15 sec',  k],
          ['-12 sec',  l],
          ['-9 sec',  m],
          ['-6 sec',  n],
          ['-3 sec',  o],
          ['Current', currentForce ]
         ]);
        try{
        	chart.draw(data, options);
        }
        catch(err)
       {
       	alert(err.message);
       }
        i = j;
		j = k;
		k = l;
		l = m;
		m = n;
		n = o;
		o = currentForce;
      }

      function connect() {
	  	clientPublish = new Paho.MQTT.Client("ws://iot.eclipse.org/ws", "myClientId1" + new Date().getTime());
		clientPublish.connect({
				onSuccess : onConnect
		});
	    function onConnect() {
	    }
	  }

      function publish() {
    	MqttPlugin.publish({
			topic:"$EDC/tum/B8:27:EB:A6:A9:8A/PY-MILLING-V1/EXEC/start",
			data:"Mqtt data"
		});
		alert("published");
	  }

	  function startMillingMachine() {
	    connect();
        publish();
		$.fn.gotof();
	  }

	  function subscribe() {
		alert("in subscribe");
		clientPublish.onMessageArrived = onMessageArrived;
		TopicToSubscribe = "$EDC/tum/BLUETOOTH-V1/00:1A:7D:DA:71:15/data";
		// Once a connection has been made, make a subscription and send a message.
		clientPublish.subscribe(TopicToSubscribe);
		alert("successfuly subscribed to the get the force values");

		function onConnect() {
			// Once a connection has been made, make a subscription and send a message.
			clientPublish.subscribe(TopicToSubscribe);
			alert("successfuly subscribed to the get the force values");
		}


		// called when the client loses its connection
		function onConnectionLost(responseObject) {
			if (responseObject.errorCode !== 0) {
				console.log("onConnectionLost:" + responseObject.errorMessage);
				//setTimeout(function() { clientPublish.connect() }, 5000);
			}
		}

		// called when a message arrives
		function onMessageArrived(message) {
			currentForce = parseInt(message.payloadString);
			//graphUpdate();
			document.getElementById("bluetoothData").innerHTML = message.payloadString;
		}

	  }

</script>

<script type="text/javascript">
	$(document).ready(function(){
		$.fn.gotof = function() { // has to be defined as a function, does not need to be inside a nested document ready function
			$('#start').addClass('loadinggif');
			$.blockUI({ message: null });
			setTimeout($.unblockUI, 10000);
			setTimeout(function() {
				$('#start').removeClass('loadinggif');
				},
				10000
			);
		};
	});
</script>

</body>
</html>